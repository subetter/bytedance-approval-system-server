# Approval System Backend - æ¥å£å®ç°é€»è¾‘è¯´æ˜

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [ä¸­é—´ä»¶å¤„ç†æµç¨‹](#ä¸­é—´ä»¶å¤„ç†æµç¨‹)
3. [å®¡æ‰¹å•æ¨¡å—æ¥å£](#å®¡æ‰¹å•æ¨¡å—æ¥å£)
4. [éƒ¨é—¨æ¨¡å—æ¥å£](#éƒ¨é—¨æ¨¡å—æ¥å£)
5. [é™„ä»¶æ¨¡å—æ¥å£](#é™„ä»¶æ¨¡å—æ¥å£)
6. [è¡¨å•é…ç½®æ¨¡å—æ¥å£](#è¡¨å•é…ç½®æ¨¡å—æ¥å£)
7. [ç”¨æˆ·æ¨¡å—æ¥å£](#ç”¨æˆ·æ¨¡å—æ¥å£)
8. [å®šæ—¶ä»»åŠ¡æœåŠ¡](#å®šæ—¶ä»»åŠ¡æœåŠ¡)
9. [æ•°æ®åº“æ“ä½œæ¨¡å¼](#æ•°æ®åº“æ“ä½œæ¨¡å¼)
10. [æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµç¨‹](#æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµç¨‹)

---

## æ•´ä½“æ¶æ„

### æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Koa.js
- **æ•°æ®åº“**: MySQL (ä½¿ç”¨ mysql2/promise)
- **æ–‡ä»¶ä¸Šä¼ **: koa-body (åŸºäº formidable)
- **å®šæ—¶ä»»åŠ¡**: node-cron
- **è·¯ç”±**: @koa/router

### é¡¹ç›®ç»“æ„
```
src/
â”œâ”€â”€ server.ts              # åº”ç”¨å…¥å£ï¼Œä¸­é—´ä»¶æ³¨å†Œ
â”œâ”€â”€ config/
â”‚   â””â”€â”€ db.ts             # æ•°æ®åº“è¿æ¥æ± é…ç½®
â”œâ”€â”€ routes/               # è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ index.ts          # è·¯ç”±æ±‡æ€»
â”‚   â”œâ”€â”€ approvalRoutes.ts
â”‚   â”œâ”€â”€ departmentRoutes.ts
â”‚   â”œâ”€â”€ attachmentRoutes.ts
â”‚   â””â”€â”€ formSchemaRoutes.ts
â”œâ”€â”€ controller/           # æ§åˆ¶å™¨ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ approvalController.ts
â”‚   â”œâ”€â”€ departmentController.ts
â”‚   â”œâ”€â”€ attachmentController.ts
â”‚   â”œâ”€â”€ formSchemaController.ts
â”‚   â””â”€â”€ userController.ts
â”œâ”€â”€ middleware/           # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ errorHandler.ts   # å…¨å±€é”™è¯¯å¤„ç†
â”‚   â””â”€â”€ logger.ts         # è¯·æ±‚æ—¥å¿—
â”œâ”€â”€ services/             # æœåŠ¡å±‚
â”‚   â””â”€â”€ attachmentCleanupService.ts  # é™„ä»¶æ¸…ç†å®šæ—¶ä»»åŠ¡
â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
    â””â”€â”€ departmentUtils.ts # éƒ¨é—¨è·¯å¾„è®¡ç®—å·¥å…·
```

### è¯·æ±‚å¤„ç†æµç¨‹
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Koa åº”ç”¨ (server.ts)
    â†“
é”™è¯¯å¤„ç†ä¸­é—´ä»¶ (errorHandlerMiddleware)
    â†“
æ—¥å¿—ä¸­é—´ä»¶ (loggerMiddleware)
    â†“
Body è§£æä¸­é—´ä»¶ (koaBody)
    â†“
è·¯ç”±åŒ¹é… (apiRouter)
    â†“
æ§åˆ¶å™¨å¤„ç† (Controller)
    â†“
æ•°æ®åº“æ“ä½œ (MySQL Pool)
    â†“
è¿”å›å“åº”
```

---

## ä¸­é—´ä»¶å¤„ç†æµç¨‹

### 1. é”™è¯¯å¤„ç†ä¸­é—´ä»¶ (errorHandlerMiddleware)

**ä½ç½®**: `src/middleware/errorHandler.ts`

**èŒè´£**:
- æ•è·æ‰€æœ‰ä¸‹æ¸¸æŠ›å‡ºçš„é”™è¯¯
- ç»Ÿä¸€æ ¼å¼åŒ–é”™è¯¯å“åº”
- åŒºåˆ†å®¢æˆ·ç«¯é”™è¯¯å’ŒæœåŠ¡å™¨é”™è¯¯

**å¤„ç†é€»è¾‘**:
```typescript
try {
  await next(); // æ‰§è¡Œä¸‹æ¸¸ä¸­é—´ä»¶å’Œè·¯ç”±
  
  // å¤„ç† 404 æƒ…å†µ
  if (ctx.status === 404 && !ctx.body) {
    ctx.throw(404, 'Resource Not Found');
  }
} catch (err) {
  // è®¾ç½®çŠ¶æ€ç 
  ctx.status = err.status || 500;
  
  // æ ¼å¼åŒ–é”™è¯¯å“åº”
  ctx.body = {
    code: ctx.status,
    error: err.name,
    message: err.message,
    details: err.details
  };
  
  // æœåŠ¡å™¨é”™è¯¯è§¦å‘äº‹ä»¶ï¼ˆç”¨äºæ—¥å¿—è®°å½•ï¼‰
  if (ctx.status >= 500) {
    ctx.app.emit('error', err, ctx);
  }
}
```

**ç‰¹ç‚¹**:
- ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- è‡ªåŠ¨åŒºåˆ† 4xxï¼ˆå®¢æˆ·ç«¯é”™è¯¯ï¼‰å’Œ 5xxï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰
- æ”¯æŒè‡ªå®šä¹‰é”™è¯¯è¯¦æƒ…ï¼ˆé€šè¿‡ `ctx.throw(400, '...', { details: ... })`ï¼‰

### 2. æ—¥å¿—ä¸­é—´ä»¶ (loggerMiddleware)

**ä½ç½®**: `src/middleware/logger.ts`

**èŒè´£**:
- è®°å½•æ‰€æœ‰è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- æ ¹æ®çŠ¶æ€ç ä½¿ç”¨ä¸åŒé¢œè‰²è¾“å‡º

**è®°å½•ä¿¡æ¯**:
- æ—¶é—´æˆ³
- HTTP æ–¹æ³•
- è¯·æ±‚ URL
- å“åº”çŠ¶æ€ç 
- å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- å®¢æˆ·ç«¯ IP

**é¢œè‰²è§„åˆ™**:
- 2xx: ç»¿è‰²
- 3xx: é’è‰²
- 4xx: é»„è‰²
- 5xx: çº¢è‰²

### 3. Body è§£æä¸­é—´ä»¶ (koaBody)

**é…ç½®**:
```typescript
koaBody({
  multipart: true,  // æ”¯æŒæ–‡ä»¶ä¸Šä¼ 
  formidable: {
    uploadDir: path.join(process.cwd(), "/public/upload"),
    keepExtensions: true,
  }
})
```

**åŠŸèƒ½**:
- è§£æ JSON è¯·æ±‚ä½“
- è§£æ URL-encoded è¡¨å•
- å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼ˆä¿å­˜åˆ° `public/upload` ç›®å½•ï¼‰

---

## å®¡æ‰¹å•æ¨¡å—æ¥å£

### è·¯ç”±å®šä¹‰
**ä½ç½®**: `src/routes/approvalRoutes.ts`

```typescript
GET    /api/approvals              # æŸ¥è¯¢åˆ—è¡¨
GET    /api/approvals/:id         # æŸ¥è¯¢è¯¦æƒ…
POST   /api/approvals             # æ–°å»ºå®¡æ‰¹å•
POST   /api/approvals/batch       # æ‰¹é‡æ–°å»º
PUT    /api/approvals/:id         # ä¿®æ”¹å®¡æ‰¹å•
POST   /api/approvals/:id/withdraw # æ’¤å›å®¡æ‰¹å•
POST   /api/approvals/:id/approve  # é€šè¿‡å®¡æ‰¹
POST   /api/approvals/:id/reject   # é©³å›å®¡æ‰¹
```

### 1. æŸ¥è¯¢å®¡æ‰¹å•åˆ—è¡¨ (GET /api/approvals)

**æ§åˆ¶å™¨**: `listApprovals`

**æ ¸å¿ƒé€»è¾‘**:

#### 1.1 ç”¨æˆ·è®¤è¯å’Œè§’è‰²è·å–
```typescript
const getAuthUser = (ctx) => {
  // ä» query æˆ– body è·å– userIdï¼ˆé»˜è®¤ 101ï¼‰
  const userId = parseInt(ctx.query.userId || '101');
  // ä» query æˆ– body è·å– roleï¼ˆé»˜è®¤ APPLICANTï¼‰
  const role = ctx.query.role || ctx.request.body?.role || 'APPLICANT';
  return { userId, role };
};
```

#### 1.2 è§’è‰²ç­›é€‰é€»è¾‘
```typescript
if (role === 'APPLICANT') {
  // ç”³è¯·äººï¼šåªæŸ¥çœ‹è‡ªå·±æäº¤çš„å®¡æ‰¹å•
  whereClauses.push('af.applicant_id = ?');
  queryParams.push(userId);
} else if (role === 'APPROVER') {
  // å®¡æ‰¹äººï¼šåªæŸ¥çœ‹å¾…å®¡æ‰¹çš„ï¼ˆçŠ¶æ€ä¸º 0ï¼‰
  whereClauses.push("af.status = '0'");
}
```

#### 1.3 åŠ¨æ€ç­›é€‰æ¡ä»¶æ„å»º
æ”¯æŒä»¥ä¸‹ç­›é€‰å‚æ•°ï¼š
- `status`: å®¡æ‰¹çŠ¶æ€ï¼ˆ0-å¾…å®¡æ‰¹, 1-é€šè¿‡, 2-é©³å›ï¼‰
- `projectName`: é¡¹ç›®åç§°ï¼ˆæ¨¡ç³ŠæŸ¥è¯¢ï¼‰
- `departmentId`: éƒ¨é—¨IDï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
- `createTimeStart/End`: åˆ›å»ºæ—¶é—´èŒƒå›´
- `approvalTimeStart/End`: å®¡æ‰¹æ—¶é—´èŒƒå›´
- `executeDateStart/End`: æ‰§è¡Œæ—¥æœŸèŒƒå›´

#### 1.4 åˆ†é¡µå¤„ç†
```typescript
const limit = parseInt(pageSize as string);
const offset = (parseInt(page as string) - 1) * limit;
```

#### 1.5 æ•°æ®æŸ¥è¯¢å’Œå…³è”
```sql
SELECT 
  af.id, af.project_name, af.status, af.content, 
  af.execute_date, af.created_at, af.approval_at,
  u.display_name AS applicant_name,
  d.name AS department_name,
  appr.display_name AS current_approver_name
FROM approval_forms af
JOIN users u ON af.applicant_id = u.id
JOIN departments d ON af.department_id = d.id
LEFT JOIN users appr ON af.current_approver_id = appr.id
WHERE ...
ORDER BY af.created_at DESC
LIMIT ? OFFSET ?
```

#### 1.6 éƒ¨é—¨è·¯å¾„è®¡ç®—
```typescript
// è¯»å–æ‰€æœ‰éƒ¨é—¨æ•°æ®
const [deptRows] = await pool.execute('SELECT id, parent_id, name FROM departments');
// è®¡ç®—éƒ¨é—¨è·¯å¾„æ˜ å°„ (id -> path)
const deptPathMap = computePathMap(deptRows);
// æ³¨å…¥åˆ°ç»“æœä¸­
item.department_path = deptPathMap.get(item.department_id) || '';
```

#### 1.7 é™„ä»¶æ‰¹é‡æŸ¥è¯¢
```typescript
// æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰å®¡æ‰¹å•çš„é™„ä»¶
const approvalIds = listResult.map(item => item.id);
const [allAttachments] = await pool.execute(
  `SELECT * FROM approval_attachments WHERE form_id IN (${placeholders})`,
  approvalIds
);

// æ„å»ºé™„ä»¶æ˜ å°„ (form_id -> attachments[])
const attachmentsMap = {};
allAttachments.forEach(att => {
  if (!attachmentsMap[att.form_id]) {
    attachmentsMap[att.form_id] = [];
  }
  // éå›¾ç‰‡ç±»å‹ä¸è¿”å› file_urlï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
  if (att.file_type !== 'IMAGE') {
    const { file_url, ...rest } = att;
    attachmentsMap[att.form_id].push(rest);
  } else {
    attachmentsMap[att.form_id].push(att);
  }
});
```

**è¿”å›æ ¼å¼**:
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "list": [...],
    "total": 100,
    "page": 1,
    "pageSize": 10
  }
}
```

### 2. æŸ¥è¯¢å®¡æ‰¹å•è¯¦æƒ… (GET /api/approvals/:id)

**æ§åˆ¶å™¨**: `getApprovalDetail`

**æ ¸å¿ƒé€»è¾‘**:

#### 2.1 ä¸»è¡¨æŸ¥è¯¢ï¼ˆè”è¡¨ï¼‰
```sql
SELECT 
  af.*,
  u.display_name AS applicant_name,
  d.name AS department_name,
  appr.display_name AS current_approver_name
FROM approval_forms af
JOIN users u ON af.applicant_id = u.id
JOIN departments d ON af.department_id = d.id
LEFT JOIN users appr ON af.current_approver_id = appr.id
WHERE af.id = ? AND af.is_deleted = FALSE
```

#### 2.2 éƒ¨é—¨è·¯å¾„æ³¨å…¥
```typescript
const deptPathMap = computePathMap(deptRows);
approvalForm.department_path = deptPathMap.get(approvalForm.department_id) || '';
```

#### 2.3 æµè½¬è®°å½•æŸ¥è¯¢
```sql
SELECT al.*, u.display_name AS operator_name
FROM approval_logs al
JOIN users u ON al.operator_id = u.id
WHERE al.form_id = ?
ORDER BY al.action_time ASC
```

#### 2.4 é™„ä»¶æŸ¥è¯¢
```sql
SELECT * FROM approval_attachments WHERE form_id = ?
```

**è¿”å›æ ¼å¼**:
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢è¯¦æƒ…æˆåŠŸ",
  "data": {
    "id": 1,
    "project_name": "...",
    "department_path": "ä¸€çº§éƒ¨é—¨/äºŒçº§éƒ¨é—¨/ä¸‰çº§éƒ¨é—¨",
    "attachments": [...],
    ...
  }
}
```

### 3. åˆ›å»ºå®¡æ‰¹å• (POST /api/approvals)

**æ§åˆ¶å™¨**: `createApproval`

**æ ¸å¿ƒé€»è¾‘**:

#### 3.1 å‚æ•°éªŒè¯
```typescript
const { projectName, content, departmentId, executeDate, attachmentIds } = ctx.request.body;
if (!projectName || !content || !departmentId || !executeDate) {
  ctx.throw(400, 'ç¼ºå°‘å¿…è¦çš„è¡¨å•å­—æ®µ');
}
```

#### 3.2 ç¡®å®šå®¡æ‰¹äºº
```typescript
// ç®€åŒ–é€»è¾‘ï¼šç¡¬ç¼–ç ç¬¬ä¸€å®¡æ‰¹äººIDä¸º 102
const nextApproverId = 102;
```

#### 3.3 æ’å…¥ä¸»è¡¨
```sql
INSERT INTO approval_forms 
  (project_name, content, department_id, execute_date, 
   applicant_id, current_approver_id, status)
VALUES (?, ?, ?, ?, ?, ?, '0')
```

#### 3.4 æ’å…¥æ—¥å¿—
```sql
INSERT INTO approval_logs (form_id, operator_id, action, comment)
VALUES (?, ?, 'CREATE', 'å®¡æ‰¹å•åˆ›å»ºæˆåŠŸ')
```

#### 3.5 å…³è”é™„ä»¶
```sql
-- å°†å·²ä¸Šä¼ ä½†æœªå…³è”çš„é™„ä»¶å…³è”åˆ°å®¡æ‰¹å•
UPDATE approval_attachments 
SET form_id = ? 
WHERE id IN (?) AND uploader_id = ? AND form_id IS NULL
```

**ç‰¹ç‚¹**:
- æ”¯æŒé™„ä»¶é¢„ä¸Šä¼ ï¼ˆ`form_id` ä¸º NULLï¼‰ï¼Œåˆ›å»ºå®¡æ‰¹å•æ—¶å†å…³è”
- è‡ªåŠ¨è®°å½•åˆ›å»ºæ—¥å¿—

### 4. æ‰¹é‡åˆ›å»ºå®¡æ‰¹å• (POST /api/approvals/batch)

**æ§åˆ¶å™¨**: `batchCreateApprovals`

**æ ¸å¿ƒé€»è¾‘**:

#### 4.1 å‚æ•°è§£æ
```typescript
const items = Array.isArray(body) ? body : [];
// æ”¯æŒä¸­æ–‡å­—æ®µåï¼ˆExcel å¯¼å…¥åœºæ™¯ï¼‰
const projectName = item.projectName || item['å®¡æ‰¹é¡¹ç›®'];
const content = item.content || item['å®¡æ‰¹å†…å®¹'];
const departmentId = item.departmentId || item['ç”³è¯·éƒ¨é—¨'];
const executeDate = item.executeDate || item['æ‰§è¡Œæ—¥æœŸ'];
```

#### 4.2 æ‰¹é‡å¤„ç†
```typescript
for (let i = 0; i < items.length; i++) {
  try {
    // æ’å…¥ä¸»è¡¨
    await pool.execute('INSERT INTO approval_forms ...');
    // æ’å…¥æ—¥å¿—
    await pool.execute('INSERT INTO approval_logs ...');
    results.success++;
  } catch (err) {
    results.failed++;
    results.errors.push({ index: i, message: err.message });
  }
}
```

**è¿”å›æ ¼å¼**:
```json
{
  "code": 200,
  "message": "æ‰¹é‡å¤„ç†å®Œæˆ: æˆåŠŸ 10 æ¡, å¤±è´¥ 0 æ¡",
  "data": {
    "success": 10,
    "failed": 0,
    "errors": []
  }
}
```

### 5. ä¿®æ”¹å®¡æ‰¹å• (PUT /api/approvals/:id)

**æ§åˆ¶å™¨**: `updateApproval`

**æ ¸å¿ƒé€»è¾‘**:

#### 5.1 æƒé™å’ŒçŠ¶æ€æ ¡éªŒ
```typescript
// æ£€æŸ¥å®¡æ‰¹å•æ˜¯å¦å­˜åœ¨
const [checkResult] = await pool.execute(
  'SELECT status, applicant_id FROM approval_forms WHERE id = ?',
  [id]
);

// åªèƒ½ä¿®æ”¹è‡ªå·±çš„å®¡æ‰¹å•ï¼Œä¸”çŠ¶æ€ä¸ºå¾…å®¡æ‰¹(0)æˆ–å·²é©³å›(2)
const allowedStatuses = ['0', '2'];
if (checkResult[0].applicant_id !== userId || 
    !allowedStatuses.includes(checkResult[0].status)) {
  ctx.throw(403, 'æ— æƒä¿®æ”¹æˆ–å®¡æ‰¹å•å·²åœ¨æµç¨‹ä¸­/å·²é€šè¿‡');
}
```

#### 5.2 æ›´æ–°ä¸»è¡¨
```sql
UPDATE approval_forms 
SET project_name = ?, content = ?, department_id = ?, execute_date = ?
WHERE id = ?
```

#### 5.3 è®°å½•æ—¥å¿—
```sql
INSERT INTO approval_logs (form_id, operator_id, action, comment)
VALUES (?, ?, 'UPDATE', 'å®¡æ‰¹å•æ•°æ®ä¿®æ”¹')
```

#### 5.4 é™„ä»¶åŒæ­¥é€»è¾‘ï¼ˆæ ¸å¿ƒï¼‰
```typescript
// 1. æŸ¥è¯¢å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰é™„ä»¶
const [currentAttachments] = await pool.execute(
  'SELECT id, file_url FROM approval_attachments WHERE form_id = ?',
  [id]
);

// 2. æ‰¾å‡ºéœ€è¦åˆ é™¤çš„é™„ä»¶ï¼ˆåœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œä½†ä¸åœ¨å‰ç«¯æäº¤çš„åˆ—è¡¨ä¸­ï¼‰
const keepIds = new Set(attachmentIds.map(id => Number(id)));
const toDelete = currentAttachments.filter(att => !keepIds.has(att.id));

// 3. åˆ é™¤ç‰©ç†æ–‡ä»¶
for (const att of toDelete) {
  const absolutePath = path.join(process.cwd(), 'public', att.file_url);
  await fs.unlink(absolutePath);
}

// 4. åˆ é™¤æ•°æ®åº“è®°å½•
await pool.execute(
  'DELETE FROM approval_attachments WHERE id IN (?)',
  deleteIds
);

// 5. ç¡®ä¿ä¿ç•™çš„é™„ä»¶éƒ½æ­£ç¡®å…³è”äº† form_id
await pool.execute(
  'UPDATE approval_attachments SET form_id = ? WHERE id IN (?)',
  [id, ...attachmentIds]
);
```

**ç‰¹ç‚¹**:
- æ”¯æŒé™„ä»¶å¢åˆ æ”¹
- è‡ªåŠ¨æ¸…ç†è¢«åˆ é™¤é™„ä»¶çš„ç‰©ç†æ–‡ä»¶
- ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 6. æ’¤å›å®¡æ‰¹å• (POST /api/approvals/:id/withdraw)

**æ§åˆ¶å™¨**: `withdrawApproval`

**æ ¸å¿ƒé€»è¾‘**:

#### 6.1 é€»è¾‘åˆ é™¤
```sql
UPDATE approval_forms SET is_deleted = TRUE WHERE id = ?
```

#### 6.2 è®°å½•æ—¥å¿—
```sql
INSERT INTO approval_logs (form_id, operator_id, action, comment)
VALUES (?, ?, 'WITHDRAW', 'ç”³è¯·äººæ’¤å›å®¡æ‰¹å•')
```

**ç‰¹ç‚¹**:
- ä½¿ç”¨é€»è¾‘åˆ é™¤ï¼ˆ`is_deleted = TRUE`ï¼‰ï¼Œæ•°æ®ä¿ç•™åœ¨æ•°æ®åº“ä¸­
- æŸ¥è¯¢åˆ—è¡¨æ—¶ä¼šè‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤çš„è®°å½•ï¼ˆ`WHERE is_deleted = FALSE`ï¼‰

### 7. é€šè¿‡å®¡æ‰¹ (POST /api/approvals/:id/approve)

**æ§åˆ¶å™¨**: `approveApproval`

**æ ¸å¿ƒé€»è¾‘**:

#### 7.1 è§’è‰²æ ¡éªŒ
```typescript
if (role !== 'APPROVER') {
  ctx.throw(403, 'åªæœ‰å®¡æ‰¹å‘˜å¯ä»¥æ‰§è¡Œé€šè¿‡æ“ä½œ');
}
```

#### 7.2 æ›´æ–°çŠ¶æ€
```sql
UPDATE approval_forms 
SET status = '1', approval_at = NOW(), current_approver_id = NULL
WHERE id = ?
```

#### 7.3 è®°å½•æ—¥å¿—
```sql
INSERT INTO approval_logs (form_id, operator_id, action, comment)
VALUES (?, ?, 'APPROVE', ?)
```

**ç‰¹ç‚¹**:
- çŠ¶æ€æ›´æ–°ä¸º '1'ï¼ˆå·²é€šè¿‡ï¼‰
- è®°å½•å®¡æ‰¹æ—¶é—´
- æ¸…ç©ºå½“å‰å®¡æ‰¹äººï¼ˆæµç¨‹ç»“æŸï¼‰

### 8. é©³å›å®¡æ‰¹ (POST /api/approvals/:id/reject)

**æ§åˆ¶å™¨**: `rejectApproval`

**æ ¸å¿ƒé€»è¾‘**:

ä¸é€šè¿‡å®¡æ‰¹ç±»ä¼¼ï¼Œä½†çŠ¶æ€æ›´æ–°ä¸º '2'ï¼ˆå·²é©³å›ï¼‰

```sql
UPDATE approval_forms 
SET status = '2', approval_at = NOW(), current_approver_id = NULL
WHERE id = ?
```

---

## éƒ¨é—¨æ¨¡å—æ¥å£

### è·¯ç”±å®šä¹‰
**ä½ç½®**: `src/routes/departmentRoutes.ts`

```typescript
GET /api/departments              # æŸ¥è¯¢éƒ¨é—¨åˆ—è¡¨/æ ‘
GET /api/departments/:id          # æŸ¥è¯¢å•ä¸ªéƒ¨é—¨
GET /api/departments/byname/:name # æ ¹æ®åç§°æŸ¥è¯¢éƒ¨é—¨
```

### 1. æŸ¥è¯¢éƒ¨é—¨åˆ—è¡¨ (GET /api/departments)

**æ§åˆ¶å™¨**: `getDepartments`

**æŸ¥è¯¢å‚æ•°**:
- `tree`: æ˜¯å¦è¿”å›æ ‘å½¢ç»“æ„ï¼ˆé»˜è®¤ trueï¼‰
- `active`: æ˜¯å¦åªè¿”å›å¯ç”¨çš„éƒ¨é—¨ï¼ˆé»˜è®¤ trueï¼‰
- `format`: æ ¼å¼åŒ–é€‰é¡¹ï¼ˆ'options' æˆ– 'select'ï¼Œç”¨äºå‰ç«¯ä¸‹æ‹‰ç»„ä»¶ï¼‰

**æ ¸å¿ƒé€»è¾‘**:

#### 1.1 æŸ¥è¯¢éƒ¨é—¨æ•°æ®
```sql
SELECT * FROM departments 
WHERE is_active = TRUE 
ORDER BY level, id
```

#### 1.2 è®¡ç®—éƒ¨é—¨è·¯å¾„
```typescript
// ä½¿ç”¨å·¥å…·å‡½æ•°è®¡ç®—æ¯ä¸ªéƒ¨é—¨çš„å®Œæ•´è·¯å¾„
computePaths(rows);
// ä¾‹å¦‚ï¼šid=3 çš„éƒ¨é—¨è·¯å¾„ä¸º "ä¸€çº§éƒ¨é—¨/äºŒçº§éƒ¨é—¨/ä¸‰çº§éƒ¨é—¨"
```

#### 1.3 æ„å»ºæ ‘å½¢ç»“æ„
```typescript
const buildTree = (rows) => {
  const map = new Map();
  const roots = [];
  
  // åˆ›å»ºèŠ‚ç‚¹æ˜ å°„
  rows.forEach(r => {
    map.set(r.id, { ...r, children: [] });
  });
  
  // æ„å»ºçˆ¶å­å…³ç³»
  rows.forEach(r => {
    const node = map.get(r.id);
    if (r.parent_id && map.has(r.parent_id)) {
      map.get(r.parent_id).children.push(node);
    } else {
      roots.push(node);
    }
  });
  
  return roots;
};
```

#### 1.4 æ ¼å¼åŒ–é€‰é¡¹ï¼ˆformat=optionsï¼‰
```typescript
const toOptionsTree = (nodes) => {
  return nodes.map(n => ({
    value: n.id,
    label: n.name,
    path: n.path,
    children: n.children?.length ? toOptionsTree(n.children) : undefined
  }));
};
```

**è¿”å›æ ¼å¼**:
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢éƒ¨é—¨æ ‘(ä¸‹æ‹‰é€‰é¡¹)æˆåŠŸ",
  "data": [
    {
      "value": 1,
      "label": "ä¸€çº§éƒ¨é—¨",
      "path": "ä¸€çº§éƒ¨é—¨",
      "children": [
        {
          "value": 2,
          "label": "äºŒçº§éƒ¨é—¨",
          "path": "ä¸€çº§éƒ¨é—¨/äºŒçº§éƒ¨é—¨"
        }
      ]
    }
  ]
}
```

### 2. æ ¹æ®åç§°æŸ¥è¯¢éƒ¨é—¨ (GET /api/departments/byname/:name)

**æ§åˆ¶å™¨**: `getDepartmentByName`

**ç”¨é€”**: Excel æ‰¹é‡å¯¼å…¥æ—¶ï¼Œæ ¹æ®éƒ¨é—¨åç§°æŸ¥æ‰¾éƒ¨é—¨ID

**æ ¸å¿ƒé€»è¾‘**:
```sql
SELECT * FROM departments WHERE name = ?
```

---

## é™„ä»¶æ¨¡å—æ¥å£

### è·¯ç”±å®šä¹‰
**ä½ç½®**: `src/routes/attachmentRoutes.ts`

```typescript
POST /api/attachments/upload  # ä¸Šä¼ é™„ä»¶
POST /api/attachments/delete  # åˆ é™¤é™„ä»¶
```

### 1. ä¸Šä¼ é™„ä»¶ (POST /api/attachments/upload)

**æ§åˆ¶å™¨**: `uploadAttachment`

**æ ¸å¿ƒé€»è¾‘**:

#### 1.1 æ–‡ä»¶è·å–
```typescript
const files = ctx.request.files;
const file = Array.isArray(files.file) ? files.file[0] : files.file;
// æ–‡ä»¶å·²ç”± koa-body ä¸­é—´ä»¶ä¿å­˜åˆ° public/upload ç›®å½•
```

#### 1.2 è·å– formIdï¼ˆå¯é€‰ï¼‰
```typescript
const formId = body.formId || body.form_id;
// æ–°å»ºæ¨¡å¼ä¸‹ formId ä¸º nullï¼Œç¼–è¾‘æ¨¡å¼ä¸‹æœ‰å€¼
```

#### 1.3 æ„å»ºæ–‡ä»¶ URL
```typescript
const basename = path.basename(filepath);
const fileUrl = `/upload/${basename}`;
// å‰ç«¯å¯é€šè¿‡ http://host/upload/xxx.png è®¿é—®
```

#### 1.4 æ¨æ–­æ–‡ä»¶ç±»å‹
```typescript
const lower = originalName.toLowerCase();
let fileType = 'OTHER';
if (/\.(jpg|jpeg|png|gif|bmp|webp)$/.test(lower)) fileType = 'IMAGE';
if (/\.(xls|xlsx)$/.test(lower)) fileType = 'EXCEL';
```

#### 1.5 ä¿å­˜åˆ°æ•°æ®åº“
```sql
INSERT INTO approval_attachments 
  (form_id, file_name, file_url, file_type, uploader_id)
VALUES (?, ?, ?, ?, ?)
```

**è¿”å›æ ¼å¼**:
```json
{
  "code": 200,
  "message": "ä¸Šä¼ æˆåŠŸ",
  "data": {
    "id": 123,
    "fileUrl": "/upload/xxx.png",
    "originalName": "image.png"
  }
}
```

**ç‰¹ç‚¹**:
- æ”¯æŒé¢„ä¸Šä¼ ï¼ˆ`form_id` ä¸º NULLï¼‰ï¼Œåˆ›å»ºå®¡æ‰¹å•æ—¶å†å…³è”
- è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹
- æ–‡ä»¶ä¿å­˜åœ¨ `public/upload` ç›®å½•ï¼Œå¯é€šè¿‡é™æ€æœåŠ¡è®¿é—®

### 2. åˆ é™¤é™„ä»¶ (POST /api/attachments/delete)

**æ§åˆ¶å™¨**: `deleteAttachment`

**æ ¸å¿ƒé€»è¾‘**:

#### 2.1 æŸ¥è¯¢é™„ä»¶è®°å½•
```sql
SELECT * FROM approval_attachments WHERE file_url = ?
```

#### 2.2 åˆ é™¤ç‰©ç†æ–‡ä»¶
```typescript
const absolutePath = path.join(process.cwd(), 'public', fileUrl);
await fs.unlink(absolutePath);
```

#### 2.3 åˆ é™¤æ•°æ®åº“è®°å½•
```sql
DELETE FROM approval_attachments WHERE id = ?
```

**ç‰¹ç‚¹**:
- åŒæ—¶åˆ é™¤ç‰©ç†æ–‡ä»¶å’Œæ•°æ®åº“è®°å½•
- æ”¯æŒæ ¡éªŒé™„ä»¶æ˜¯å¦å±äºæŒ‡å®šå®¡æ‰¹å•

---

## è¡¨å•é…ç½®æ¨¡å—æ¥å£

### è·¯ç”±å®šä¹‰
**ä½ç½®**: `src/routes/formSchemaRoutes.ts`

```typescript
GET /api/form/schema?key=basic_approval  # è·å–è¡¨å•é…ç½®
```

### 1. è·å–è¡¨å•é…ç½® (GET /api/form/schema)

**æ§åˆ¶å™¨**: `getFormSchema`

**æ ¸å¿ƒé€»è¾‘**:

#### 1.1 è·å–é…ç½® Key
```typescript
const key = ctx.query.key || 'basic_approval';
```

#### 1.2 æŸ¥è¯¢æ•°æ®åº“
```sql
SELECT schema_content FROM form_schemas 
WHERE schema_key = ? AND is_active = TRUE
```

#### 1.3 è¿”å›é…ç½®
```json
{
  "code": 200,
  "msg": "success",
  "data": [
    {
      "field": "projectName",
      "name": "å®¡æ‰¹é¡¹ç›®",
      "component": "Input",
      "validator": {
        "required": true,
        "maxCount": 20
      }
    },
    {
      "field": "departmentId",
      "name": "ç”³è¯·éƒ¨é—¨",
      "component": "Cascader",
      "validator": {
        "required": true
      }
    },
    ...
  ]
}
```

**ç”¨é€”**:
- å‰ç«¯æ ¹æ®é…ç½®åŠ¨æ€ç”Ÿæˆè¡¨å•å­—æ®µå’Œè¡¨æ ¼åˆ—
- æ”¯æŒå¤šå¥—é…ç½®ï¼ˆbasic_approval, no_time_version_approval, simple_approvalï¼‰

---

## ç”¨æˆ·æ¨¡å—æ¥å£

### è·¯ç”±å®šä¹‰
**ä½ç½®**: `src/controller/userController.ts`

```typescript
GET /api/users  # æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
```

### 1. æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ (GET /api/users)

**æ§åˆ¶å™¨**: `getUserList`

**æ ¸å¿ƒé€»è¾‘**:
```sql
SELECT * FROM users
```

**è¿”å›æ ¼å¼**:
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨æˆåŠŸ",
  "data": [...]
}
```

---

## å®šæ—¶ä»»åŠ¡æœåŠ¡

### é™„ä»¶æ¸…ç†ä»»åŠ¡

**ä½ç½®**: `src/services/attachmentCleanupService.ts`

**åŠŸèƒ½**: æ¸…ç†æœªå…³è”å®¡æ‰¹å•ä¸”è¶…è¿‡1ä¸ªæœˆçš„é™„ä»¶

**æ‰§è¡Œæ—¶é—´**: æ¯å¤©å‡Œæ™¨ 3:00

**æ ¸å¿ƒé€»è¾‘**:

#### 1. æŸ¥æ‰¾è¿‡æœŸé™„ä»¶
```sql
SELECT id, file_url FROM approval_attachments 
WHERE form_id IS NULL 
AND uploaded_at < DATE_SUB(NOW(), INTERVAL 1 MONTH)
```

#### 2. åˆ é™¤ç‰©ç†æ–‡ä»¶
```typescript
for (const row of rows) {
  const absolutePath = path.join(process.cwd(), 'public', row.file_url);
  try {
    await fs.unlink(absolutePath);
  } catch (err) {
    // æ–‡ä»¶ä¸å­˜åœ¨ä¹Ÿè§†ä¸ºæˆåŠŸ
    if (err.code !== 'ENOENT') {
      console.error('ç‰©ç†æ–‡ä»¶åˆ é™¤å¤±è´¥:', err);
      continue; // è·³è¿‡æ•°æ®åº“åˆ é™¤
    }
  }
  idsToDelete.push(row.id);
}
```

#### 3. æ‰¹é‡åˆ é™¤æ•°æ®åº“è®°å½•
```sql
DELETE FROM approval_attachments WHERE id IN (?)
```

**ç‰¹ç‚¹**:
- é˜²æ­¢ç£ç›˜ç©ºé—´æµªè´¹
- åªæ¸…ç†æœªå…³è”çš„é™„ä»¶ï¼ˆ`form_id IS NULL`ï¼‰
- å·²å…³è”çš„é™„ä»¶ä¸ä¼šè¢«æ¸…ç†

---

## æ•°æ®åº“æ“ä½œæ¨¡å¼

### 1. è¿æ¥æ± é…ç½®

**ä½ç½®**: `src/config/db.ts`

```typescript
const pool = mysql.createPool({
  host: "localhost",
  port: 3306,
  user: "root",
  password: "123456",
  database: "approval",
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
});
```

**ç‰¹ç‚¹**:
- ä½¿ç”¨è¿æ¥æ± æé«˜æ€§èƒ½
- è‡ªåŠ¨ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- æ”¯æŒå¹¶å‘è¯·æ±‚

### 2. SQL æ‰§è¡Œæ¨¡å¼

```typescript
// æŸ¥è¯¢ï¼ˆè¿”å›æ•°ç»„ï¼‰
const [rows] = await pool.execute<RowDataPacket[]>(
  'SELECT * FROM table WHERE id = ?',
  [id]
);

// æ’å…¥/æ›´æ–°ï¼ˆè¿”å›ç»“æœå¯¹è±¡ï¼‰
const [result] = await pool.execute(
  'INSERT INTO table (name) VALUES (?)',
  [name]
);
const insertId = (result as any).insertId;

// æ‰¹é‡æ“ä½œï¼ˆä½¿ç”¨å ä½ç¬¦ï¼‰
const placeholders = ids.map(() => '?').join(',');
await pool.execute(
  `SELECT * FROM table WHERE id IN (${placeholders})`,
  ids
);
```

### 3. äº‹åŠ¡å¤„ç†

**æ³¨æ„**: å½“å‰å®ç°æœªä½¿ç”¨äº‹åŠ¡ï¼Œä½†åœ¨ä»¥ä¸‹åœºæ™¯å»ºè®®ä½¿ç”¨ï¼š
- åˆ›å»ºå®¡æ‰¹å• + å…³è”é™„ä»¶
- ä¿®æ”¹å®¡æ‰¹å• + åŒæ­¥é™„ä»¶
- æ‰¹é‡åˆ›å»ºå®¡æ‰¹å•

**å»ºè®®æ”¹è¿›**:
```typescript
const connection = await pool.getConnection();
await connection.beginTransaction();
try {
  await connection.execute('INSERT INTO ...');
  await connection.execute('UPDATE ...');
  await connection.commit();
} catch (err) {
  await connection.rollback();
  throw err;
} finally {
  connection.release();
}
```

---

## æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµç¨‹

### 1. å®¡æ‰¹å•åˆ›å»ºæµç¨‹

```
ç”¨æˆ·æäº¤è¡¨å•
    â†“
å‰ç«¯ä¸Šä¼ é™„ä»¶ï¼ˆformId = nullï¼‰
    â†“
åç«¯ä¿å­˜é™„ä»¶è®°å½•ï¼ˆform_id = NULLï¼‰
    â†“
å‰ç«¯åˆ›å»ºå®¡æ‰¹å•ï¼ˆä¼ é€’ attachmentIdsï¼‰
    â†“
åç«¯æ’å…¥å®¡æ‰¹å•ä¸»è¡¨
    â†“
åç«¯æ’å…¥åˆ›å»ºæ—¥å¿—
    â†“
åç«¯å…³è”é™„ä»¶ï¼ˆUPDATE approval_attachments SET form_id = ?ï¼‰
    â†“
è¿”å›åˆ›å»ºç»“æœ
```

### 2. å®¡æ‰¹å•ä¿®æ”¹æµç¨‹

```
ç”¨æˆ·ä¿®æ”¹è¡¨å•
    â†“
å‰ç«¯ä¸Šä¼ æ–°é™„ä»¶ï¼ˆformId = å®¡æ‰¹å•IDï¼‰
    â†“
åç«¯ä¿å­˜é™„ä»¶è®°å½•ï¼ˆform_id = å®¡æ‰¹å•IDï¼‰
    â†“
å‰ç«¯æäº¤ä¿®æ”¹ï¼ˆä¼ é€’ attachmentIds = æœ€ç»ˆä¿ç•™çš„é™„ä»¶IDåˆ—è¡¨ï¼‰
    â†“
åç«¯æ ¡éªŒæƒé™å’ŒçŠ¶æ€
    â†“
åç«¯æ›´æ–°å®¡æ‰¹å•ä¸»è¡¨
    â†“
åç«¯æŸ¥è¯¢å½“å‰æ‰€æœ‰é™„ä»¶
    â†“
åç«¯è®¡ç®—éœ€è¦åˆ é™¤çš„é™„ä»¶ï¼ˆæ•°æ®åº“ä¸­å­˜åœ¨ä½†ä¸åœ¨æäº¤åˆ—è¡¨ä¸­ï¼‰
    â†“
åç«¯åˆ é™¤ç‰©ç†æ–‡ä»¶
    â†“
åç«¯åˆ é™¤æ•°æ®åº“è®°å½•
    â†“
åç«¯ç¡®ä¿ä¿ç•™çš„é™„ä»¶æ­£ç¡®å…³è”
    â†“
åç«¯æ’å…¥ä¿®æ”¹æ—¥å¿—
    â†“
è¿”å›ä¿®æ”¹ç»“æœ
```

### 3. å®¡æ‰¹æµç¨‹

```
ç”³è¯·äººåˆ›å»ºå®¡æ‰¹å•ï¼ˆstatus = '0', current_approver_id = 102ï¼‰
    â†“
å®¡æ‰¹äººæŸ¥çœ‹å¾…å®¡æ‰¹åˆ—è¡¨ï¼ˆWHERE status = '0'ï¼‰
    â†“
å®¡æ‰¹äººæ‰§è¡Œæ“ä½œï¼ˆé€šè¿‡/é©³å›ï¼‰
    â†“
åç«¯æ›´æ–°çŠ¶æ€ï¼ˆstatus = '1'/'2', approval_at = NOW(), current_approver_id = NULLï¼‰
    â†“
åç«¯æ’å…¥å®¡æ‰¹æ—¥å¿—
    â†“
æµç¨‹ç»“æŸ
```

### 4. éƒ¨é—¨è·¯å¾„è®¡ç®—æµç¨‹

```
æŸ¥è¯¢æ‰€æœ‰éƒ¨é—¨æ•°æ®
    â†“
æ„å»ºéƒ¨é—¨æ˜ å°„ï¼ˆid -> éƒ¨é—¨å¯¹è±¡ï¼‰
    â†“
é€’å½’è®¡ç®—æ¯ä¸ªéƒ¨é—¨çš„è·¯å¾„
    â†“
ç¼“å­˜è·¯å¾„ç»“æœï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
    â†“
è¿”å›è·¯å¾„æ˜ å°„ï¼ˆMap<id, path>ï¼‰
```

**è·¯å¾„è®¡ç®—ç®—æ³•**:
```typescript
function buildPathForId(id) {
  if (ç¼“å­˜ä¸­æœ‰) return ç¼“å­˜å€¼;
  
  const node = map.get(id);
  if (!node.parent_id) {
    return node.name; // æ ¹èŠ‚ç‚¹
  }
  
  // é€’å½’è®¡ç®—çˆ¶èŠ‚ç‚¹è·¯å¾„
  const parentPath = buildPathForId(node.parent_id);
  return parentPath ? `${parentPath}/${node.name}` : node.name;
}
```

---

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. é€»è¾‘åˆ é™¤
- ä½¿ç”¨ `is_deleted` å­—æ®µæ ‡è®°åˆ é™¤
- æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤ï¼ˆ`WHERE is_deleted = FALSE`ï¼‰
- æ•°æ®ä¿ç•™ï¼Œä¾¿äºå®¡è®¡å’Œæ¢å¤

### 2. é™„ä»¶é¢„ä¸Šä¼ 
- æ–°å»ºæ¨¡å¼ä¸‹ï¼Œé™„ä»¶å…ˆä¸Šä¼ ï¼ˆ`form_id = NULL`ï¼‰
- åˆ›å»ºå®¡æ‰¹å•æ—¶å†å…³è”
- æ”¯æŒå®šæ—¶ä»»åŠ¡æ¸…ç†æœªå…³è”çš„è¿‡æœŸé™„ä»¶

### 3. è§’è‰²é©±åŠ¨æ•°æ®è¿‡æ»¤
- ç”³è¯·äººï¼šåªæŸ¥çœ‹è‡ªå·±æäº¤çš„
- å®¡æ‰¹äººï¼šåªæŸ¥çœ‹å¾…å®¡æ‰¹çš„ï¼ˆ`status = '0'`ï¼‰
- é€šè¿‡ WHERE å­å¥è‡ªåŠ¨è¿‡æ»¤

### 4. ç»Ÿä¸€å“åº”æ ¼å¼
```typescript
{
  code: 200,        // HTTP çŠ¶æ€ç 
  message: "...",   // æç¤ºä¿¡æ¯
  data: {...}       // æ•°æ®
}
```

### 5. é”™è¯¯å¤„ç†
- ä½¿ç”¨ `ctx.throw()` æŠ›å‡ºé”™è¯¯
- å…¨å±€é”™è¯¯ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†
- åŒºåˆ†å®¢æˆ·ç«¯é”™è¯¯ï¼ˆ4xxï¼‰å’ŒæœåŠ¡å™¨é”™è¯¯ï¼ˆ5xxï¼‰

---

## æ€»ç»“

### æ ¸å¿ƒç‰¹ç‚¹
1. **RESTful API è®¾è®¡**: éµå¾ª REST è§„èŒƒ
2. **è§’è‰²æƒé™æ§åˆ¶**: åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤
3. **åŠ¨æ€è¡¨å•æ”¯æŒ**: é€šè¿‡ Schema é…ç½®é©±åŠ¨å‰ç«¯
4. **é™„ä»¶ç®¡ç†**: æ”¯æŒé¢„ä¸Šä¼ ã€å…³è”ã€åˆ é™¤
5. **æ—¥å¿—è®°å½•**: æ‰€æœ‰æ“ä½œéƒ½è®°å½•åˆ° approval_logs
6. **å®šæ—¶ä»»åŠ¡**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸé™„ä»¶

### æ”¹è¿›å»ºè®®
1. **äº‹åŠ¡æ”¯æŒ**: å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
2. **è®¤è¯æˆæƒ**: å®ç° JWT æˆ– Session è®¤è¯
3. **å‚æ•°éªŒè¯**: ä½¿ç”¨ Joi æˆ– class-validator è¿›è¡Œå‚æ•°æ ¡éªŒ
4. **ç¼“å­˜ä¼˜åŒ–**: éƒ¨é—¨æ•°æ®å¯ä»¥ç¼“å­˜
5. **åˆ†é¡µä¼˜åŒ–**: å¤§æ•°æ®é‡æ—¶ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
6. **æ–‡ä»¶å­˜å‚¨**: è€ƒè™‘ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆOSSï¼‰æ›¿ä»£æœ¬åœ°å­˜å‚¨

